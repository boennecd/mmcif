test_that("jac_log_chol_inv works", {
  n <- 4L
  X <- structure(
    c(3.60383511197394, -0.391348218288545, -2.50285845976795,-0.255695880956116, -0.391348218288545, 1.43571871121384, 0.541066835210331,2.1903225348546, -2.50285845976795, 0.541066835210331, 2.90816906247951,0.903203915050414, -0.255695880956116, 2.1903225348546, 0.903203915050414, 3.46586468614804),
    .Dim = c(n, n))

  # C <- log_chol(X)
  # numDeriv::jacobian(log_chol_inv, C) |> dput()
  # dum <- matrix(0, n, n)
  # for(i in seq_len(n))
  #   dum[1:i, i] <- (i * (i - 1L)) %/% 2L + 1:i
  # dum <- t(dum)[lower.tri(dum, TRUE)]
  # dum <- order(dum)
  # dput(matrixcalc::duplication.matrix(n)[, dum])
  jac <- structure(
    c(7.20767022395412, -0.391348218288666, -2.50285845979384, -0.255695880955749, -0.391348218288666, 0, 0, 0, -2.50285845979384, 0, 0, 0, -0.255695880955749, 0, 0, 0, 0, 1.89837696781724, 0, 0, 1.89837696781724, -0.412297688961026, -1.31842015689898, -0.13469183691305, 0, -1.31842015689898, 0, 0, 0, -0.13469183691305, 0, 0, 0, 0, 0, 0, 0, 2.78644273011907, 0.269276043299639, 2.16255596826063, 0, 0.269276043299639, 0, 0, 0, 2.16255596826063, 0, 0, 0, 0, 1.89837696781479, 0, 0, 0, -0.20614884447202, 0, 1.89837696781479, -0.20614884447202, -2.63684031374706, -0.134691836915512, 0, 0, -0.134691836915512, 0, 0, 0, 0, 0, 0, 0, 1.18034798476475, 0, 0, 1.18034798476475, 0.456265519687744, 1.83213424874425, 0, 0, 1.83213424874425, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2.2357855922206, 0.307653639684394, 0, 0, 0.307653639684394, 0, 0, 0, 0, 1.89837696786348, 0, 0, 0, -0.206148844466446, 0, 0, 0, -1.31842015688735, 1.89837696786348, -0.206148844466446, -1.31842015688735, -0.269383673830505, 0, 0, 0, 0, 0, 0, 0, 1.18034798477244, 0, 0, 0, 0.228132759839687, 0, 1.18034798477244, 0.228132759839687, 3.66426849748136, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1.05730449554539, 0, 0, 1.05730449554539, 0.581958444358494, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.0126759641452034),
    .Dim = c(n * n, (n * (n + 1L)) %/% 2L))
  D <- structure(c(
    1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1),
    .Dim = c(n * n, (n * (n + 1L)) %/% 2L))

  expect_equal(crossprod(D, jac), jac_log_chol_inv(log_chol(X)))
})
