library(mmcif)
cpp_obj <- mmcif_data(
  ~ a + b, dat, cause = cause, time = time, cluster_id = cluster_id,
  max_time = delta, spline_df = 2L, left_trunc = dat$delayed_entry)

comb_slope <- sapply(cpp_obj$spline, function(spline){
  boundary_knots <- spline$boundary_knots
  pts <- seq(boundary_knots[1], boundary_knots[2], length.out = 1000)
  lm.fit(cbind(1, spline$expansion(pts)), pts)$coef
})

log_chol <- function(x){
  x <- chol(x)
  diag(x) <- log(diag(x))
  x[upper.tri(x, TRUE)]
}

log_chol_inv <- function(x){
  dim <- (sqrt(8 * length(x) + 1) - 1) / 2
  out <- matrix(0, dim, dim)
  out[upper.tri(out, TRUE)] <- x
  diag(out) <- exp(diag(out))
  crossprod(out)
}

# with(gaussHermiteData(10L), list(node = x, weight = w)) |> dput()
ghq_data <- list(
  node = c(-3.43615911883774, -2.53273167423279, -1.75668364929988, -1.03661082978951, -0.342901327223705, 0.342901327223705, 1.03661082978951, 1.75668364929988, 2.53273167423279, 3.43615911883774),
  weight = c(7.6404328552326e-06, 0.00134364574678124, 0.0338743944554811, 0.240138611082314, 0.610862633735326, 0.610862633735326, 0.240138611082315, 0.033874394455481, 0.00134364574678124, 7.64043285523265e-06))

coef_traject_spline <-
  rbind(comb_slope[-1, ] * rep(coef_traject[1, ], each = NROW(comb_slope) - 1),
        coef_traject[2, ] + comb_slope[1, ] * coef_traject[1, ],
        coef_traject[-(1:2), ])

ll_func_chol <- function(par, n_threads = 1L, ghq = ghq_data){
  n_vcov <- (2L * n_causes * (2L * n_causes + 1L)) %/% 2L
  par <- c(head(par, -n_vcov), log_chol_inv(tail(par, n_vcov)))

  mmcif:::mmcif_logLik(
    cpp_obj$comp_obj, par = par, ghq_data = ghq, n_threads = n_threads)
}

ll_func_chol_grad <- function(par, n_threads = 1L, ghq = ghq_data){
  n_vcov <- (2L * n_causes * (2L * n_causes + 1L)) %/% 2L
  vcov <- log_chol_inv(tail(par, n_vcov))
  par <- c(head(par, -n_vcov), vcov)

  gr <- mmcif:::mmcif_logLik_grad(
    cpp_obj$comp_obj, par = par, ghq_data = ghq, n_threads = n_threads)

  # back propagate the gradients w.r.t. the random effects
  d_vcov <- matrix(tail(gr, 4L * n_causes * n_causes), 2L * n_causes)
  C <- chol(vcov)
  d_vcov <- 2 * C %*% d_vcov
  diag(d_vcov) <- diag(d_vcov) * diag(C)

  c(head(gr, -4L * n_causes * n_causes), d_vcov[upper.tri(d_vcov, TRUE)])
}

truth <- c(coef_risk, coef_traject_spline, log_chol(Sigma))

test_that("the log composite likelihood gives the same as previously", {
  # ll_func_chol(truth, 1) |> dput()
  log_compos <- -439.949278998529
  expect_equal(ll_func_chol(truth, 1), log_compos)
  expect_equal(ll_func_chol(truth, 2), log_compos)
})

test_that("the gradient of log composite likelihood match the one from numerical differentation", {
  # numDeriv::grad(\(x) ll_func_chol(x, 1), truth) |> dput()
  grad_log_compos <- c(-2.10856790649602, 27.4239565755946, 2.30429599534527, 20.0963783392411, -17.8491973129057, 1.04607771693571, -8.74030143511687, 14.2383928150414, -8.40145900230978, 18.7570071562292, -21.2130993129746, 2.06867787244102, -8.5291673063807, 4.94853852069349, 7.58574858682438, 0.0930760225780529, -1.81161748374386, -3.10896359203321, 6.59004476369612, -6.85988430981942, 4.67223350169804, 2.06253506147011, -8.23184803800954, 7.60108260892427, 0.916561613714819, -11.3836942217331)
  expect_equal(ll_func_chol_grad(truth, 1), grad_log_compos, tolerance = 1e-6)
  expect_equal(ll_func_chol_grad(truth, 2), grad_log_compos, tolerance = 1e-6)
})

test_that("the Hessian of log composite likelihood match the one from numerical differentation", {
  # numDeriv::jacobian(\(x) ll_func_chol_grad(x, 1), truth) |> dput()
  hess_log_compos <- structure(c(
    -68.8828018665492, -4.27369322987701, 0.549078772516207,
    26.1549402119675, 5.49932440335191, 0.965712213843877, -5.22926313437199,
    1.6892200746586, -13.5155459675591, -1.85038421920009, 1.4324550091421,
    2.72875933781267, -0.619159473688295, 6.43980337331456, -1.00040879789092,
    0.133610372243406, 2.71506090618655, -2.09478725762884, 12.9436448267863,
    -3.68490908600844, 2.09833436071, -1.04373837228134, -2.82031165603218,
    5.21687563575723, 0.75356685517818, 0.135954980311669, -4.27369336631176,
    -48.1400015906668, 0.981598240761102, 5.0301712295405, 20.5333298084372,
    -0.142861461017576, 0.157857457761188, -0.55247696316448, -0.153873792235287,
    -6.65472326935594, 1.44898596637694, -0.0486317395926015, -0.0362656677387856,
    0.120363890195098, 2.42970629271316, -0.044792539945279, 2.14590899761481,
    -1.53467364027952, 2.49364983585329, -0.89202086847706, 0.727290287066897,
    0.722294503137739, -1.41539532495408, 1.30274606755335, 0.18064050938093,
    -0.256781683462508, 0.549078766840375, 0.981598262054794, -27.092852811727,
    1.02106521846813, -0.122214223474105, 10.9989104496633, 0.743809668672445,
    -0.533428756438613, 0.979066179079285, 1.41023312833388, -3.88628247783128,
    -0.0528525954085978, -0.0806965559013198, -0.129042499895854,
    -0.165064839209116, 1.52566422226721, -1.20475395691663, 0.859435949109216,
    -0.503171230696824, 2.06951525790065, -1.20256036303832, 0.144255616549582,
    -0.0237655354846377, -0.0299758274434893, -0.365486561366169,
    0.0520493956712054, 26.1549389920943, 5.03017094716173, 1.02106511307743,
    -49.3176385232887, 7.03734630508869, -0.863049889883799, 3.5581019392314,
    -0.49175253733455, 8.70633518904658, 3.02341386850584, -0.33555737261229,
    -3.32472614922001, 1.49606723849707, -8.47822117797569, 3.6453079666475,
    -0.396455031248693, -0.193444487650928, 8.1379754162783, -22.4944485007078,
    1.39772383161656, -1.79435340851752, 0.926840692935793, 3.16707338266118,
    -7.60070618112396, -1.10650327753447, 1.1844513610189, 5.49932493823503,
    20.5333296642692, -0.122214164603249, 7.03734564628453, -44.8581189393269,
    0.816976831147713, 0.418173880870129, 0.250924837140699, 0.904780434959077,
    3.20413033695025, -0.547287795212497, 1.30946208135466, -0.621112409791287,
    3.1064023960758, -7.06814060846071, 0.482618095935812, -1.09136157883493,
    1.20914815670053, 1.92907828298834, 0.471047395903566, -1.21311487003076,
    0.236247057981959, 0.591910332773855, 0.869218981250427, -0.0267992925115112,
    -0.117198097172712, 0.965712238497819, -0.142861447281573, 10.9989101242395,
    -0.863050082522095, 0.816976890570364, -19.2934220353604, -0.173045874358891,
    0.159254533599977, -0.032216192505686, -0.415043679554542, 2.33726820532089,
    -0.0841158117739737, 0.041654880072824, -0.141288137827258, 0.599077822133456,
    -2.17908942853035, 0.404514373285121, -0.978382450125582, 0.833299093880151,
    -0.552709438754977, 1.50744141673288, -0.438637293423384, -0.0675811077820398,
    -0.456266431821721, 0.200561190112161, -0.514303484874191, -5.22925487350476,
    0.157770725643927, 0.744443431576242, 3.55802581146595, 0.417955304837334,
    -0.173043121553752, -27.09351385935, 7.07473641517021, -37.7582333934815,
    -27.6989392189147, 1.54664311361637, -0.563271799513035, -0.0992349144678465,
    -1.29885940613064, 0.404982944371096, -0.114233373327218, 1.10421471101232,
    -0.878827960106854, 1.96199758831348, -3.70782199116422, 0.195603458712561,
    -7.2221493142297, 0.0597134354212403, -0.55437007805414, -0.132673342225911,
    -0.258177944184184, 1.68921341213768, -0.552428455711123, -0.533761642951594,
    -0.49171257021772, 0.251020143400402, 0.159250699161118, 7.07471785237542,
    -24.3387909918193, -0.415810779470144, -4.88944592150254, 0.320737190547677,
    -0.124063543658174, 0.105483815822778, -0.385182217464213, -0.159047126367462,
    -0.0338831954792765, 0.0507318283172757, -0.426832460383513,
    0.0856649410358632, 8.82219455224839, -9.34942516069824, -22.3002348553717,
    0.270307464202272, -0.444440500833974, -0.744525571973254, 0.118450498827678,
    -13.5155180677247, -0.154073308090027, 0.980443700245759, 8.70616506555165,
    0.904356979011434, -0.0322148903994628, -37.7582206217453, -0.415779062607411,
    -91.9706994427253, -45.2781696507124, -1.62741394457543, -1.2778230414885,
    -0.199494077359429, -2.91619908626045, 1.11837815934641, -0.0720963744169992,
    2.57688116073853, -1.87288465529917, 4.61216307724878, -13.9977653946996,
    6.22825274754974, -4.73200696985333, 0.0511306105113017, -1.24520826546618,
    -0.486380719997881, -0.554439525049142, -1.85038445926654, -6.65473064811359,
    1.4103066955501, 3.02338756073795, 3.20407706915006, -0.414999902143686,
    -27.6988297553972, -4.88950907768402, -45.2779453271771, -92.2463451875918,
    7.35222574590313, -1.10456696058223, -0.304359212451151, -2.79366463305373,
    0.693330634458332, -0.174535331536693, 1.5362711669943, -1.37762460427566,
    1.5360213981797, 0.222288641552138, -4.09884965137464, -9.7440833396566,
    0.421889591632696, -1.67722615589866, -1.81054388595191, -0.544957912288877,
    1.43242371243216, 1.44913214199913, -3.88723330075294, -0.335629718326095,
    -0.547330483724411, 2.33715958992408, 1.54635524057714, 0.320858709095826,
    -1.62797951240661, 7.35226167952409, -46.6565216638212, 0.0481110696499753,
    0.0026053383332285, 0.291329176779207, -0.249230629348314, 0.0755751500880006,
    0.261745797386063, -0.551006881637115, 0.136331383867604, -6.72791439566704,
    9.09037661834795, 15.0742240681428, -0.27731702353053, 0.363126807557649,
    0.451480351484201, 0.0338319198392724, 2.72876024937469, -0.0486634438813495,
    -0.0529949205064317, -3.324766976433, 1.3094561596068, -0.0841071466449491,
    -0.563279357456333, -0.124066979385416, -1.27782556959601, -1.10451156003933,
    0.0481271306437225, -15.702012191973, 4.94456960313459, -22.4167623347935,
    6.755537200567, -0.885793182899727, 1.37916534657099, -3.80411854580304,
    0.908069408135483, -0.34886592911373, -0.545274409849625, 0.0950798549525949,
    2.05515706121854, -11.0727664609953, 0.610400668340589, -6.92575760702038,
    -0.619158946376493, -0.0362495964458806, -0.0806298809790922,
    1.49608932943169, -0.62110434532069, 0.0416435496552365, -0.0992373547456451,
    0.105488272555892, -0.199505129119945, -0.304383856009, 0.00260133549336889,
    4.94459197820992, -18.3670234981698, 1.26530594783981, -4.42741215370212,
    1.97224899260579, 0.245376528119618, -0.411314119883987, 0.611456035433802,
    0.121314077682105, 0.0738747934835828, 0.0704447860374273, -3.543834646315,
    3.16676789182533, 2.75360788665983, -7.63087141489985, 6.43980147291658,
    0.120300918167775, -0.129295716273078, -8.47830693775797, 3.10637361818785,
    -0.141241759183765, -1.29887068995187, -0.385189537563843, -2.91619682802851,
    -2.79356345577753, 0.291379023207537, -22.4167808484599, 1.26527016283841,
    -49.971161863819, 17.4992149166601, -1.6009673446122, 2.74242642455124,
    -7.90239857539661, 1.29558509204806, -0.627428462875771, -1.44283320357785,
    0.0669957278244556, 7.42447283174196, -26.8918121623536, -0.588192919282261,
    -7.88653781381007, -1.00041036414908, 2.42974191417447, -0.164924117603097,
    3.64532258040947, -7.0681299520216, 0.599159638247295, 0.404933239140481,
    -0.159015977475354, 1.11825730273708, 0.693340119708273, -0.249250785057307,
    6.75564477793774, -4.42744338607127, 17.4994240588646, -51.5884362243059,
    1.71549548526132, -0.31493952643438, 2.81313250604497, -1.0493923086176,
    -0.00708752100073185, 0.634060019209655, -0.246698111907037,
    0.189300636849977, 7.54288834960773, -0.567239764497312, -1.26706889268974,
    0.133577366902872, -0.0448172155970943, 1.52578248318743, -0.396468496906113,
    0.482489025840229, -2.17892000781524, -0.114229312288752, -0.0338795340897337,
    -0.0720861109132919, -0.174588159390649, 0.0756135008657666,
    -0.885867715609227, 1.97228561262204, -1.60110282974007, 1.71561337651836,
    -18.8528098644372, 0.0572941925820681, -0.29230784485278, -0.193158644770955,
    -0.559225469324449, 0.272728681358683, 0.00884094412635398, 0.585517755584306,
    -2.03037938146803, -1.57603393522393, -0.779418652321449, 2.71505473860959,
    2.14595361413358, -1.20503446722034, -0.193508858694879, -1.09139338429892,
    0.404544528073098, 1.10421762264012, 0.0507290300269675, 2.57689470276782,
    1.53630161513085, 0.261712872029851, 1.37920906595842, 0.245353477620708,
    2.74250931499779, -0.315152251946606, 0.0572207050980902, -4.89735994439441,
    -2.16000908539397, -1.4975915445991, -3.3153500456083, -1.30694302230812,
    -0.204618075481359, -2.25003123003479, 0.636497713603218, -0.557368638532645,
    1.13595739930284, -2.09477489368836, -1.53472523512237, 0.859842960195213,
    8.13803799992059, 1.20916454871289, -0.978376154895659, -0.878222867683093,
    -0.426874909138621, -1.87242822484387, -1.37665865717608, -0.543757948966273,
    -3.80418770735991, -0.411340812579152, -7.90228602015983, 2.81251041114155,
    -0.290195547556922, -2.1569938937762, 2.99795236050384, 7.61345133324913,
    2.58751180889759, 2.87325821041583, -0.718086579445758, 3.69530923804062,
    -2.20420773154805, 0.792309352972514, -2.62554177352199, 12.9436772378112,
    2.49357870221656, -0.502943572427224, -22.4945216013509, 1.9290440348129,
    0.833348371890348, 1.96240568250866, 0.0854158073822125, 4.61313026217713,
    1.53606519227565, 0.135974192816177, 0.907777462164984, 0.611581299762177,
    1.29503120208867, -1.04933702738996, -0.193113614582453, -1.49769263639306,
    7.61516312199912, -4.30788845269376, 1.29832993450492, 0.158352549803172,
    0.984481096404353, 1.51256569166735, 1.1263130399929, -0.917380775115772,
    1.93229318764335, -3.68488900571778, -0.891855517163749, 2.06804174033039,
    1.39752758091729, 0.47111962709791, -0.553035096452569, -3.70845848881192,
    8.82252980237466, -13.9991885180511, 0.222354317500581, -6.72709548395819,
    -0.349003674473228, 0.12137521143391, -0.627706818170764, -0.00691211811226598,
    -0.559332942804037, -3.31507747621221, 2.57730572940907, 1.29811690157523,
    -11.1218814590706, 12.3013799700305, 18.1313470500191, -2.04163759526327,
    -1.17442281986025, -2.61960022340984, -0.0829668737052775, 2.09827735929663,
    0.727508392026082, -1.20384258374227, -1.79418434783368, -1.21305315316292,
    1.50717603861982, 0.196101565717882, -9.34971097662396, 6.22947850192995,
    -4.09823988650413, 9.08915640837278, -0.545324257821644, 0.0739134870414157,
    -1.44295211283595, 0.634156219379805, 0.272847549131915, -1.30718398863494,
    2.86957876232338, 0.160441286710449, 12.2989174091467, -15.1185415158691,
    -18.8850674601342, -0.453906640032361, -2.73916363901198, 1.93463500015791,
    0.111726969962089, -1.04373751412957, 0.72229568541155, 0.14425531383925,
    0.926840605604645, 0.23624513791055, -0.438636445845726, -7.2225477001292,
    -22.3000295236829, -4.73286621765627, -9.74412474002387, 15.0746531476528,
    0.0948948874720125, 0.0705326148958178, 0.0666534544131251, -0.246446508916263,
    0.00898412834704568, -0.204332369568902, -0.718439599301062,
    0.984073940646688, 18.1321196451797, -18.8842682141584, -43.8390596080251,
    0.0316108432252618, 0.102222849112169, -1.81228043836324, 0.104499375261394,
    -2.82028356609371, -1.41540383911367, -0.0240274465873819, 3.16711914423915,
    0.592050197858269, -0.0678933205013879, 0.0597098930606642, 0.270297246978564,
    0.0511295083879836, 0.421954781899985, -0.277434663484491, 2.05509790235703,
    -3.54380014163417, 7.42433181950906, 0.189748478446183, 0.585273384944666,
    -2.25015726344374, 3.69687082245928, 1.51263617334832, -2.04158348474719,
    -0.454019006958709, 0.0318567291556292, -18.8862462002414, 4.12435196863528,
    2.49617198846201, 0.152537282659271, 5.2168909056066, 1.30266497020051,
    -0.0304781074150017, -7.60082500323608, 0.869283101265916, -0.456363627052699,
    -0.554353609854466, -0.444472973713592, -1.24514353388002, -1.67702772552795,
    0.363109354505606, -11.0728217044401, 3.16673826441473, -26.8919032949407,
    7.54260760253672, -2.03065908451591, 0.63621377351725, -2.20258197160893,
    1.12722260950017, -1.17410877773846, -2.73878275129849, 0.102812713990086,
    4.12462395266861, -31.6082442530035, -2.77171119341472, -3.83096127164692,
    0.753567211079458, 0.180640574961081, -0.365487068169986, -1.10650396922298,
    -0.026799502539423, 0.20056151440542, -0.132783022739668, -0.744485360191847,
    -0.486577300657455, -1.8104527625402, 0.451468903006852, 0.610468999985777,
    2.75357080901341, -0.588053979392977, -0.567587352919405, -1.57603490980986,
    -0.557411119530622, 0.79232790602726, -0.917176249844099, -2.61945158669928,
    1.93420767639693, -1.81228170868148, 2.49639396164281, -2.77144157463726,
    -26.2337412821747, 2.08434446959441, 0.135954653217563, -0.256782110989589,
    0.0520493353252593, 1.18445140707268, -0.117197245298147, -0.514304242677228,
    -0.258091525677408, 0.118419347043194, -0.554286189410252, -0.545030692110685,
    0.0338499865281503, -6.92587033155894, -7.63081024238147, -7.88677208003288,
    -1.26680063586995, -0.779420031064921, 1.13597344307386, -2.62554310613405,
    1.93205925690041, -0.0831055341455204, 0.112054181050417, 0.104499252355697,
    0.152395649518924, -3.83143304372454, 2.08434503017348, -30.2803474893072
  ), .Dim = c(26L, 26L))

  sandwich_value <- mmcif_sandwich(
    cpp_obj, truth, ghq_data = ghq_data, n_threads = 2L)

  expect_equal(attr(sandwich_value, "hessian"), hess_log_compos,
               tolerance = 1e-3)
  expect_snapshot_value(
    sandwich_value, style = "serialize", tolerance = 1e-4)
})
